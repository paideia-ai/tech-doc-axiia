<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schema Visualization</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 32px;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }

        /* Navigation */
        .nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            position: sticky;
            top: 0;
            background: #1a1a2e;
            padding: 15px 0;
            z-index: 100;
        }
        .nav-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            background: #16213e;
            color: #aaa;
        }
        .nav-btn:hover, .nav-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        /* Schema Container */
        .schemas-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Schema Card */
        .schema-card {
            background: #16213e;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }
        .schema-card:hover {
            transform: translateY(-5px);
        }
        .schema-card.highlight {
            box-shadow: 0 0 0 3px #667eea, 0 4px 20px rgba(102, 126, 234, 0.4);
        }

        .schema-header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .schema-icon {
            font-size: 28px;
        }
        .schema-title {
            font-size: 18px;
            font-weight: 600;
        }
        .schema-stage {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 10px;
            margin-left: auto;
        }

        /* Stage Colors */
        .stage-1 .schema-header { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .stage-1 .schema-stage { background: rgba(255,255,255,0.2); }
        .stage-2 .schema-header { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .stage-2 .schema-stage { background: rgba(255,255,255,0.2); }
        .stage-3 .schema-header { background: linear-gradient(135deg, #fa709a, #fee140); }
        .stage-3 .schema-stage { background: rgba(255,255,255,0.2); }
        .stage-4 .schema-header { background: linear-gradient(135deg, #a18cd1, #fbc2eb); }
        .stage-4 .schema-stage { background: rgba(255,255,255,0.2); }
        .stage-5 .schema-header { background: linear-gradient(135deg, #ff9a9e, #fecfef); }
        .stage-5 .schema-stage { background: rgba(255,255,255,0.2); }
        .stage-common .schema-header { background: linear-gradient(135deg, #536976, #292E49); }
        .stage-common .schema-stage { background: rgba(255,255,255,0.2); }
        .stage-config .schema-header { background: linear-gradient(135deg, #7F7FD5, #86A8E7); }
        .stage-config .schema-stage { background: rgba(255,255,255,0.2); }

        .schema-body {
            padding: 15px 20px;
        }
        .schema-desc {
            color: #888;
            font-size: 13px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2a2a4a;
        }

        /* Field Styles */
        .field {
            display: flex;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid #2a2a4a;
        }
        .field:last-child {
            border-bottom: none;
        }
        .field-name {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            color: #7dd3fc;
            min-width: 180px;
            flex-shrink: 0;
        }
        .field-type {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .field-desc {
            font-size: 12px;
            color: #888;
            flex: 1;
        }

        /* Type Colors */
        .type-string { background: #065f46; color: #6ee7b7; }
        .type-number { background: #7c2d12; color: #fdba74; }
        .type-boolean { background: #581c87; color: #d8b4fe; }
        .type-array { background: #1e3a5f; color: #7dd3fc; }
        .type-object { background: #3f3f46; color: #d4d4d8; }
        .type-ref { background: #4a1d96; color: #c4b5fd; cursor: pointer; }
        .type-ref:hover { background: #6d28d9; }
        .type-null { background: #374151; color: #9ca3af; }
        .type-union { background: #831843; color: #f9a8d4; }
        .type-enum { background: #164e63; color: #67e8f9; }

        /* Required/Optional Badge */
        .field-required {
            font-size: 10px;
            padding: 1px 5px;
            border-radius: 3px;
            margin-left: 5px;
        }
        .required { background: #dc2626; color: white; }
        .optional { background: #4b5563; color: #d1d5db; }

        /* Nested Schema */
        .nested {
            margin-left: 20px;
            padding-left: 15px;
            border-left: 2px solid #3f3f46;
            margin-top: 10px;
        }
        .nested-title {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Flow Diagram */
        .flow-section {
            max-width: 1200px;
            margin: 0 auto 40px;
            background: #16213e;
            border-radius: 12px;
            padding: 30px;
        }
        .flow-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
            color: #667eea;
        }
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .flow-box {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .flow-box:hover {
            transform: scale(1.05);
        }
        .flow-arrow {
            color: #667eea;
            font-size: 24px;
        }
        .flow-1 { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .flow-2 { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .flow-3 { background: linear-gradient(135deg, #fa709a, #fee140); color: #333; }
        .flow-4 { background: linear-gradient(135deg, #a18cd1, #fbc2eb); color: #333; }
        .flow-5 { background: linear-gradient(135deg, #ff9a9e, #fecfef); color: #333; }

        /* Legend */
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding: 15px;
            background: #16213e;
            border-radius: 8px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }
        .legend-box {
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: #0f0f23;
            border: 1px solid #667eea;
            border-radius: 8px;
            padding: 10px 15px;
            max-width: 300px;
            z-index: 1000;
            display: none;
            font-size: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        /* Relationship lines */
        .relationships {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        .rel-title {
            text-align: center;
            margin-bottom: 15px;
            color: #667eea;
        }
        .rel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .rel-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #1a1a2e;
            border-radius: 8px;
        }
        .rel-from, .rel-to {
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        .rel-arrow {
            color: #667eea;
        }
        .rel-label {
            font-size: 11px;
            color: #888;
        }

        @media (max-width: 768px) {
            .schemas-container {
                grid-template-columns: 1fr;
            }
            .field-name {
                min-width: 120px;
            }
            .flow-diagram {
                flex-direction: column;
            }
            .flow-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <h1>üìê Zod Schema Visualization</h1>
    <p class="subtitle">Score Post-LLM Pipeline Data Structures</p>

    <!-- Navigation -->
    <div class="nav">
        <button class="nav-btn active" onclick="filterSchemas('all')">All Schemas</button>
        <button class="nav-btn" onclick="filterSchemas('common')">Common Types</button>
        <button class="nav-btn" onclick="filterSchemas('stage-1')">Stage 1</button>
        <button class="nav-btn" onclick="filterSchemas('stage-2')">Stage 2</button>
        <button class="nav-btn" onclick="filterSchemas('stage-3')">Stage 3</button>
        <button class="nav-btn" onclick="filterSchemas('stage-4')">Stage 4</button>
        <button class="nav-btn" onclick="filterSchemas('stage-5')">Stage 5</button>
        <button class="nav-btn" onclick="filterSchemas('config')">Config</button>
    </div>

    <!-- Data Flow -->
    <div class="flow-section">
        <div class="flow-title">üìä Data Flow Through Pipeline</div>
        <div class="flow-diagram">
            <div class="flow-box flow-1" onclick="scrollToSchema('ReportJSON')">ReportJSON</div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-box flow-2" onclick="scrollToSchema('JSONScores')">JSONScores</div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-box flow-3" onclick="scrollToSchema('ScorePool')">ScorePool</div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-box flow-3" onclick="scrollToSchema('Curve')">Curve</div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-box flow-4" onclick="scrollToSchema('CurvedLetterGrades')">CurvedLetterGrades</div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-box flow-5" onclick="scrollToSchema('CurvedReport')">CurvedReport</div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item"><span class="legend-box type-string">string</span> Text</div>
        <div class="legend-item"><span class="legend-box type-number">number</span> Number</div>
        <div class="legend-item"><span class="legend-box type-boolean">boolean</span> True/False</div>
        <div class="legend-item"><span class="legend-box type-array">Type[]</span> Array</div>
        <div class="legend-item"><span class="legend-box type-object">object</span> Object</div>
        <div class="legend-item"><span class="legend-box type-ref">‚ÜíSchema</span> Reference (click)</div>
        <div class="legend-item"><span class="legend-box type-enum">enum</span> Fixed values</div>
        <div class="legend-item"><span class="legend-box type-union">union</span> One of many</div>
        <div class="legend-item"><span class="legend-box type-null">null</span> Null value</div>
    </div>

    <!-- Relationships -->
    <div class="relationships">
        <div class="rel-title">üîó Schema Relationships</div>
        <div class="rel-grid">
            <div class="rel-item">
                <span class="rel-from flow-1">ReportJSON</span>
                <span class="rel-arrow">‚Üí</span>
                <span class="rel-to flow-2">JSONScores</span>
                <span class="rel-label">extracts to</span>
            </div>
            <div class="rel-item">
                <span class="rel-from flow-2">JSONScores[]</span>
                <span class="rel-arrow">‚Üí</span>
                <span class="rel-to flow-3">ScorePool</span>
                <span class="rel-label">aggregates into</span>
            </div>
            <div class="rel-item">
                <span class="rel-from flow-3">ScorePool</span>
                <span class="rel-arrow">‚Üí</span>
                <span class="rel-to flow-3">Curve</span>
                <span class="rel-label">computes</span>
            </div>
            <div class="rel-item">
                <span class="rel-from flow-2">JSONScores</span>
                <span class="rel-arrow">+</span>
                <span class="rel-from flow-3">Curve</span>
                <span class="rel-arrow">‚Üí</span>
                <span class="rel-to flow-4">CurvedLetterGrades</span>
            </div>
            <div class="rel-item">
                <span class="rel-from flow-1">ReportJSON</span>
                <span class="rel-arrow">+</span>
                <span class="rel-from flow-4">Grades</span>
                <span class="rel-arrow">‚Üí</span>
                <span class="rel-to flow-5">CurvedReport</span>
            </div>
            <div class="rel-item">
                <span class="rel-from flow-5">CurvedReport</span>
                <span class="rel-arrow">refs</span>
                <span class="rel-to flow-3">Curve</span>
                <span class="rel-label">via applied_curve_id</span>
            </div>
        </div>
    </div>

    <!-- Schema Cards -->
    <div class="schemas-container">

        <!-- Common Types -->
        <div class="schema-card stage-common" data-stage="common" id="schema-CommonTypes">
            <div class="schema-header">
                <span class="schema-icon">üî§</span>
                <span class="schema-title">Common Types</span>
                <span class="schema-stage">BASE</span>
            </div>
            <div class="schema-body">
                <div class="schema-desc">Reusable primitive types used across all schemas</div>

                <div class="field">
                    <span class="field-name">ProblemId</span>
                    <span class="field-type type-string">string</span>
                    <span class="field-desc">6-8 digits. Last digit = language (0=‰∏≠Êñá, 1=EN)</span>
                </div>
                <div class="field">
                    <span class="field-name">DimensionId</span>
                    <span class="field-type type-string">string</span>
                    <span class="field-desc">e.g., "verification", "critical_thinking"</span>
                </div>
                <div class="field">
                    <span class="field-name">EventId</span>
                    <span class="field-type type-string">string</span>
                    <span class="field-desc">e.g., "event_2024_01"</span>
                </div>
                <div class="field">
                    <span class="field-name">PromptVersionHash</span>
                    <span class="field-type type-string">string</span>
                    <span class="field-desc">Git commit hash (7-40 hex chars)</span>
                </div>
                <div class="field">
                    <span class="field-name">LetterGrade</span>
                    <span class="field-type type-enum">enum</span>
                    <span class="field-desc">"A" | "B" | "C" | "D" | "X" (X = uncurved)</span>
                </div>
                <div class="field">
                    <span class="field-name">ScoreValue</span>
                    <span class="field-type type-number">number</span>
                    <span class="field-desc">0.0 to 1.0 (normalized score)</span>
                </div>
            </div>
        </div>

        <!-- ReportJSON -->
        <div class="schema-card stage-1" data-stage="stage-1" id="schema-ReportJSON">
            <div class="schema-header">
                <span class="schema-icon">üìÑ</span>
                <span class="schema-title">ReportJSON</span>
                <span class="schema-stage">Stage 1 Output</span>
            </div>
            <div class="schema-body">
                <div class="schema-desc">LLM-generated report. <strong>letter_grades MUST be null</strong> (uncurved state)</div>

                <div class="field">
                    <span class="field-name">report_id</span>
                    <span class="field-type type-string">uuid</span>
                    <span class="field-desc">Unique identifier</span>
                </div>
                <div class="field">
                    <span class="field-name">event_id</span>
                    <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíEventId</span>
                    <span class="field-desc">Which event this belongs to</span>
                </div>
                <div class="field">
                    <span class="field-name">prompt_version_hash</span>
                    <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíPromptVersionHash</span>
                    <span class="field-desc">Git hash of prompts used</span>
                </div>
                <div class="field">
                    <span class="field-name">generated_at</span>
                    <span class="field-type type-string">datetime</span>
                    <span class="field-desc">ISO 8601 timestamp</span>
                </div>
                <div class="field">
                    <span class="field-name">participant_id</span>
                    <span class="field-type type-string">string</span>
                    <span class="field-desc">Who took the assessment</span>
                </div>
                <div class="field">
                    <span class="field-name">problems</span>
                    <span class="field-type type-array">Problem[]</span>
                    <span class="field-desc">Per-problem scores</span>
                </div>
                <div class="nested">
                    <div class="nested-title">Problem structure:</div>
                    <div class="field">
                        <span class="field-name">problem_id</span>
                        <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíProblemId</span>
                    </div>
                    <div class="field">
                        <span class="field-name">dimension_scores</span>
                        <span class="field-type type-object">Record&lt;DimensionId, Score&gt;</span>
                    </div>
                    <div class="field">
                        <span class="field-name">objective_score</span>
                        <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíScoreValue</span>
                    </div>
                </div>
                <div class="field">
                    <span class="field-name">abilities</span>
                    <span class="field-type type-array">AbilityDimension[]</span>
                    <span class="field-desc">Per-dimension aggregated scores</span>
                </div>
                <div class="nested">
                    <div class="nested-title">AbilityDimension structure:</div>
                    <div class="field">
                        <span class="field-name">dimension_id</span>
                        <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíDimensionId</span>
                    </div>
                    <div class="field">
                        <span class="field-name">score</span>
                        <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíScoreValue</span>
                    </div>
                </div>
                <div class="field">
                    <span class="field-name">overall_score</span>
                    <span class="field-type type-union">ScoreValue | null</span>
                    <span class="field-desc">Geometric mean of ability scores</span>
                </div>
                <div class="field" style="background: #2d1f1f;">
                    <span class="field-name">letter_grades</span>
                    <span class="field-type type-null">null</span>
                    <span class="field-desc">‚ö†Ô∏è MUST be null for uncurved reports!</span>
                </div>
            </div>
        </div>

        <!-- JSONScores -->
        <div class="schema-card stage-2" data-stage="stage-2" id="schema-JSONScores">
            <div class="schema-header">
                <span class="schema-icon">üìä</span>
                <span class="schema-title">JSONScores</span>
                <span class="schema-stage">Stage 2 Output</span>
            </div>
            <div class="schema-body">
                <div class="schema-desc">Extracted scores from ReportJSON. Flat structure for processing.</div>

                <div class="field">
                    <span class="field-name">source_report_id</span>
                    <span class="field-type type-string">uuid</span>
                    <span class="field-desc">üîó Links back to ReportJSON.report_id</span>
                </div>
                <div class="field">
                    <span class="field-name">event_id</span>
                    <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíEventId</span>
                    <span class="field-desc">Copied from source report</span>
                </div>
                <div class="field">
                    <span class="field-name">participant_id</span>
                    <span class="field-type type-string">string</span>
                    <span class="field-desc">Copied from source report</span>
                </div>
                <div class="field">
                    <span class="field-name">overall_score</span>
                    <span class="field-type type-union">ScoreValue | null</span>
                    <span class="field-desc">Total score</span>
                </div>
                <div class="field">
                    <span class="field-name">ability_scores</span>
                    <span class="field-type type-array">AbilityScore[]</span>
                    <span class="field-desc">Flattened ability scores</span>
                </div>
                <div class="nested">
                    <div class="field">
                        <span class="field-name">dimension_id</span>
                        <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíDimensionId</span>
                    </div>
                    <div class="field">
                        <span class="field-name">score</span>
                        <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíScoreValue</span>
                    </div>
                </div>
                <div class="field">
                    <span class="field-name">problem_scores</span>
                    <span class="field-type type-array">ProblemScore[]</span>
                    <span class="field-desc">Flattened problem scores with nested dimensions</span>
                </div>
                <div class="nested">
                    <div class="field">
                        <span class="field-name">problem_id</span>
                        <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíProblemId</span>
                    </div>
                    <div class="field">
                        <span class="field-name">objective_score</span>
                        <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíScoreValue</span>
                    </div>
                    <div class="field">
                        <span class="field-name">dimension_scores</span>
                        <span class="field-type type-array">AbilityScore[]</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ScorePool -->
        <div class="schema-card stage-3" data-stage="stage-3" id="schema-ScorePool">
            <div class="schema-header">
                <span class="schema-icon">üèä</span>
                <span class="schema-title">ScorePool</span>
                <span class="schema-stage">Stage 3a Output</span>
            </div>
            <div class="schema-body">
                <div class="schema-desc">Aggregated scores from multiple participants. Input for curve computation.</div>

                <div class="field">
                    <span class="field-name">event_id</span>
                    <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíEventId</span>
                    <span class="field-desc">All scores must be from this event</span>
                </div>
                <div class="field">
                    <span class="field-name">prompt_version_hash</span>
                    <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíPromptVersionHash</span>
                    <span class="field-desc">Prompt version for these scores</span>
                </div>
                <div class="field">
                    <span class="field-name">problem_ids</span>
                    <span class="field-type type-array">ProblemId[]</span>
                    <span class="field-desc">Problems included in this pool</span>
                </div>
                <div class="field">
                    <span class="field-name">dimension_ids</span>
                    <span class="field-type type-array">DimensionId[]</span>
                    <span class="field-desc">Dimensions included in this pool</span>
                </div>
                <div class="field">
                    <span class="field-name">scores</span>
                    <span class="field-type type-ref" onclick="scrollToSchema('JSONScores')">‚ÜíJSONScores[]</span>
                    <span class="field-desc">All participant scores</span>
                </div>
            </div>
        </div>

        <!-- Curve -->
        <div class="schema-card stage-3" data-stage="stage-3" id="schema-Curve">
            <div class="schema-header">
                <span class="schema-icon">üìà</span>
                <span class="schema-title">Curve</span>
                <span class="schema-stage">Stage 3b Output</span>
            </div>
            <div class="schema-body">
                <div class="schema-desc">Grade thresholds computed from score pool. Can be applied to compatible scores.</div>

                <div class="field">
                    <span class="field-name">curve_id</span>
                    <span class="field-type type-string">uuid</span>
                    <span class="field-desc">Unique identifier for this curve</span>
                </div>
                <div class="field">
                    <span class="field-name">source_event_id</span>
                    <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíEventId</span>
                    <span class="field-desc">Event scores came from</span>
                </div>
                <div class="field">
                    <span class="field-name">prompt_version_hash</span>
                    <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíPromptVersionHash</span>
                    <span class="field-desc">Prompt version of source scores</span>
                </div>
                <div class="field">
                    <span class="field-name">problem_ids</span>
                    <span class="field-type type-array">ProblemId[]</span>
                    <span class="field-desc">Problems this curve applies to</span>
                </div>
                <div class="field">
                    <span class="field-name">dimension_ids</span>
                    <span class="field-type type-array">DimensionId[]</span>
                    <span class="field-desc">Dimensions this curve applies to</span>
                </div>
                <div class="field">
                    <span class="field-name">method</span>
                    <span class="field-type type-ref" onclick="scrollToSchema('CurveMethod')">‚ÜíCurveMethod</span>
                    <span class="field-desc">How thresholds were computed</span>
                </div>
                <div class="field">
                    <span class="field-name">sample_size</span>
                    <span class="field-type type-number">int</span>
                    <span class="field-desc">Number of participants in pool</span>
                </div>
                <div class="field">
                    <span class="field-name">computed_at</span>
                    <span class="field-type type-string">datetime</span>
                    <span class="field-desc">When curve was computed</span>
                </div>
                <div class="field">
                    <span class="field-name">overall</span>
                    <span class="field-type type-object">ThresholdDef</span>
                    <span class="field-desc">Overall grade thresholds</span>
                </div>
                <div class="nested">
                    <div class="field">
                        <span class="field-name">thresholds</span>
                        <span class="field-type type-array">number[]</span>
                        <span class="field-desc">[A_min, B_min, C_min] descending</span>
                    </div>
                    <div class="field">
                        <span class="field-name">grades</span>
                        <span class="field-type type-array">string[]</span>
                        <span class="field-desc">["A", "B", "C", "D"]</span>
                    </div>
                </div>
                <div class="field">
                    <span class="field-name">ability_curves</span>
                    <span class="field-type type-array">AbilityCurve[]</span>
                    <span class="field-desc">Per-dimension thresholds</span>
                </div>
                <div class="field">
                    <span class="field-name">problem_curves</span>
                    <span class="field-type type-array">ProblemCurve[]</span>
                    <span class="field-desc">Per-problem thresholds</span>
                </div>
            </div>
        </div>

        <!-- CurveMethod -->
        <div class="schema-card stage-3" data-stage="stage-3" id="schema-CurveMethod">
            <div class="schema-header">
                <span class="schema-icon">‚öôÔ∏è</span>
                <span class="schema-title">CurveMethod</span>
                <span class="schema-stage">Discriminated Union</span>
            </div>
            <div class="schema-body">
                <div class="schema-desc">How curve thresholds are computed. One of three types.</div>

                <div class="nested-title">Option 1: Percentile</div>
                <div class="nested">
                    <div class="field">
                        <span class="field-name">type</span>
                        <span class="field-type type-enum">"percentile"</span>
                    </div>
                    <div class="field">
                        <span class="field-name">percentiles</span>
                        <span class="field-type type-array">number[]</span>
                        <span class="field-desc">[0.8, 0.5, 0.2] = top 20%‚ÜíA, etc.</span>
                    </div>
                </div>

                <div class="nested-title">Option 2: Standard Deviation</div>
                <div class="nested">
                    <div class="field">
                        <span class="field-name">type</span>
                        <span class="field-type type-enum">"standard_deviation"</span>
                    </div>
                    <div class="field">
                        <span class="field-name">sigma_boundaries</span>
                        <span class="field-type type-array">number[]</span>
                        <span class="field-desc">[1, 0, -1] = mean¬±œÉ boundaries</span>
                    </div>
                </div>

                <div class="nested-title">Option 3: Absolute</div>
                <div class="nested">
                    <div class="field">
                        <span class="field-name">type</span>
                        <span class="field-type type-enum">"absolute"</span>
                    </div>
                    <div class="field">
                        <span class="field-name">thresholds</span>
                        <span class="field-type type-array">ScoreValue[]</span>
                        <span class="field-desc">[0.9, 0.7, 0.5] = fixed cutoffs</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- CurvedLetterGrades -->
        <div class="schema-card stage-4" data-stage="stage-4" id="schema-CurvedLetterGrades">
            <div class="schema-header">
                <span class="schema-icon">üéØ</span>
                <span class="schema-title">CurvedLetterGrades</span>
                <span class="schema-stage">Stage 4 Output</span>
            </div>
            <div class="schema-body">
                <div class="schema-desc">Result of applying curve to scores. Intermediate before final merge.</div>

                <div class="field">
                    <span class="field-name">source_scores_id</span>
                    <span class="field-type type-string">uuid</span>
                    <span class="field-desc">üîó Links to JSONScores (via report_id)</span>
                </div>
                <div class="field">
                    <span class="field-name">curve_id</span>
                    <span class="field-type type-string">uuid</span>
                    <span class="field-desc">üîó Links to Curve.curve_id</span>
                </div>
                <div class="field">
                    <span class="field-name">computed_at</span>
                    <span class="field-type type-string">datetime</span>
                    <span class="field-desc">When grades were computed</span>
                </div>
                <div class="field">
                    <span class="field-name">overall_grade</span>
                    <span class="field-type type-enum">"A"|"B"|"C"|"D"</span>
                    <span class="field-desc">No "X" - must be curved</span>
                </div>
                <div class="field">
                    <span class="field-name">ability_grades</span>
                    <span class="field-type type-array">AbilityGrade[]</span>
                    <span class="field-desc">Per-dimension grades</span>
                </div>
                <div class="nested">
                    <div class="field">
                        <span class="field-name">dimension_id</span>
                        <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíDimensionId</span>
                    </div>
                    <div class="field">
                        <span class="field-name">grade</span>
                        <span class="field-type type-enum">"A"|"B"|"C"|"D"</span>
                    </div>
                </div>
                <div class="field">
                    <span class="field-name">problem_grades</span>
                    <span class="field-type type-array">ProblemGrade[]</span>
                    <span class="field-desc">Per-problem grades</span>
                </div>
            </div>
        </div>

        <!-- CurvedReport -->
        <div class="schema-card stage-5" data-stage="stage-5" id="schema-CurvedReport">
            <div class="schema-header">
                <span class="schema-icon">üìù</span>
                <span class="schema-title">CurvedReport</span>
                <span class="schema-stage">Stage 5 Output (Final)</span>
            </div>
            <div class="schema-body">
                <div class="schema-desc">Final report with letter grades. Created by merging ReportJSON + CurvedLetterGrades.</div>

                <div class="field">
                    <span class="field-name">curved_report_id</span>
                    <span class="field-type type-string">uuid</span>
                    <span class="field-desc">New unique ID for curved version</span>
                </div>
                <div class="field" style="background: #1f2d1f;">
                    <span class="field-name">source_report_id</span>
                    <span class="field-type type-string">uuid</span>
                    <span class="field-desc">üîó Links to original ReportJSON</span>
                </div>
                <div class="field">
                    <span class="field-name">event_id</span>
                    <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíEventId</span>
                    <span class="field-desc">Copied from source</span>
                </div>
                <div class="field">
                    <span class="field-name">prompt_version_hash</span>
                    <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíPromptVersionHash</span>
                    <span class="field-desc">Copied from source</span>
                </div>
                <div class="field" style="background: #1f2d1f;">
                    <span class="field-name">applied_curve_id</span>
                    <span class="field-type type-string">uuid</span>
                    <span class="field-desc">üîó Which Curve was used (traceability!)</span>
                </div>
                <div class="field">
                    <span class="field-name">curved_at</span>
                    <span class="field-type type-string">datetime</span>
                    <span class="field-desc">When curve was applied</span>
                </div>
                <div class="field">
                    <span class="field-name">participant_id</span>
                    <span class="field-type type-string">string</span>
                    <span class="field-desc">Copied from source</span>
                </div>
                <div class="field">
                    <span class="field-name">problems</span>
                    <span class="field-type type-array">Problem[]</span>
                    <span class="field-desc">Copied from source (scores unchanged)</span>
                </div>
                <div class="field">
                    <span class="field-name">abilities</span>
                    <span class="field-type type-array">AbilityDimension[]</span>
                    <span class="field-desc">Copied from source (scores unchanged)</span>
                </div>
                <div class="field">
                    <span class="field-name">overall_score</span>
                    <span class="field-type type-union">ScoreValue | null</span>
                    <span class="field-desc">Copied from source</span>
                </div>
                <div class="field" style="background: #2d1f2f;">
                    <span class="field-name">letter_grades</span>
                    <span class="field-type type-object">LetterGradesInReport</span>
                    <span class="field-desc">‚≠ê NOW POPULATED (not null!)</span>
                </div>
                <div class="nested">
                    <div class="field">
                        <span class="field-name">overall</span>
                        <span class="field-type type-enum">"A"|"B"|"C"|"D"</span>
                    </div>
                    <div class="field">
                        <span class="field-name">abilities</span>
                        <span class="field-type type-object">Record&lt;DimensionId, Grade&gt;</span>
                    </div>
                    <div class="field">
                        <span class="field-name">problems</span>
                        <span class="field-type type-object">Record&lt;ProblemId, Grade&gt;</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- CompatibilityResult -->
        <div class="schema-card stage-4" data-stage="stage-4" id="schema-CompatibilityResult">
            <div class="schema-header">
                <span class="schema-icon">üîç</span>
                <span class="schema-title">CompatibilityResult</span>
                <span class="schema-stage">Stage 4a Check</span>
            </div>
            <div class="schema-body">
                <div class="schema-desc">Result of checking if a Curve can be applied to JSONScores.</div>

                <div class="nested-title">Option 1: Compatible ‚úÖ</div>
                <div class="nested">
                    <div class="field">
                        <span class="field-name">status</span>
                        <span class="field-type type-enum">"compatible"</span>
                        <span class="field-desc">Safe to apply curve</span>
                    </div>
                </div>

                <div class="nested-title">Option 2: Incompatible ‚ùå</div>
                <div class="nested">
                    <div class="field">
                        <span class="field-name">status</span>
                        <span class="field-type type-enum">"incompatible"</span>
                    </div>
                    <div class="field">
                        <span class="field-name">reasons</span>
                        <span class="field-type type-array">string[]</span>
                        <span class="field-desc">Why it's incompatible</span>
                    </div>
                </div>

                <div class="nested-title">Option 3: Requires Override ‚ö†Ô∏è</div>
                <div class="nested">
                    <div class="field">
                        <span class="field-name">status</span>
                        <span class="field-type type-enum">"requires_override"</span>
                    </div>
                    <div class="field">
                        <span class="field-name">warnings</span>
                        <span class="field-type type-array">string[]</span>
                    </div>
                    <div class="field">
                        <span class="field-name">differences</span>
                        <span class="field-type type-object">object</span>
                        <span class="field-desc">What differs</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- EventConfig -->
        <div class="schema-card stage-config" data-stage="config" id="schema-EventConfig">
            <div class="schema-header">
                <span class="schema-icon">‚öôÔ∏è</span>
                <span class="schema-title">EventConfig</span>
                <span class="schema-stage">Configuration</span>
            </div>
            <div class="schema-body">
                <div class="schema-desc">Configuration for an assessment event.</div>

                <div class="field">
                    <span class="field-name">event_id</span>
                    <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíEventId</span>
                    <span class="field-desc">Unique event identifier</span>
                </div>
                <div class="field">
                    <span class="field-name">name</span>
                    <span class="field-type type-string">string</span>
                    <span class="field-desc">Human-readable name</span>
                </div>
                <div class="field">
                    <span class="field-name">problem_ids</span>
                    <span class="field-type type-array">ProblemId[]</span>
                    <span class="field-desc">Problems in this event</span>
                </div>
                <div class="field">
                    <span class="field-name">dimension_ids</span>
                    <span class="field-type type-array">DimensionId[]</span>
                    <span class="field-desc">Dimensions scored</span>
                </div>
                <div class="field">
                    <span class="field-name">language</span>
                    <span class="field-type type-enum">"zh" | "en"</span>
                    <span class="field-desc">Event language</span>
                </div>
                <div class="field">
                    <span class="field-name">prompt_version_hash</span>
                    <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíPromptVersionHash</span>
                    <span class="field-desc">Prompts version for this event</span>
                </div>
            </div>
        </div>

        <!-- DimensionDependencyConfig -->
        <div class="schema-card stage-config" data-stage="config" id="schema-DimensionDependencyConfig">
            <div class="schema-header">
                <span class="schema-icon">üîó</span>
                <span class="schema-title">DimensionDependencyConfig</span>
                <span class="schema-stage">Configuration</span>
            </div>
            <div class="schema-body">
                <div class="schema-desc">Maps which problems contribute to which dimensions.</div>

                <div class="field">
                    <span class="field-name">version</span>
                    <span class="field-type type-string">string</span>
                    <span class="field-desc">Config version</span>
                </div>
                <div class="field">
                    <span class="field-name">updated_at</span>
                    <span class="field-type type-string">datetime</span>
                    <span class="field-desc">Last update time</span>
                </div>
                <div class="field">
                    <span class="field-name">dependencies</span>
                    <span class="field-type type-array">Dependency[]</span>
                    <span class="field-desc">Dimension-problem mappings</span>
                </div>
                <div class="nested">
                    <div class="field">
                        <span class="field-name">dimension_id</span>
                        <span class="field-type type-ref" onclick="scrollToSchema('CommonTypes')">‚ÜíDimensionId</span>
                    </div>
                    <div class="field">
                        <span class="field-name">contributing_problem_ids</span>
                        <span class="field-type type-array">ProblemId[]</span>
                        <span class="field-desc">Problems that score this dimension</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        function filterSchemas(stage) {
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(stage) ||
                    (stage === 'all' && btn.textContent === 'All Schemas') ||
                    (stage === 'common' && btn.textContent === 'Common Types') ||
                    (stage === 'config' && btn.textContent === 'Config')) {
                    btn.classList.add('active');
                }
            });

            // Filter cards
            document.querySelectorAll('.schema-card').forEach(card => {
                if (stage === 'all') {
                    card.style.display = 'block';
                } else if (stage === 'common') {
                    card.style.display = card.dataset.stage === 'common' ? 'block' : 'none';
                } else if (stage === 'config') {
                    card.style.display = card.dataset.stage === 'config' ? 'block' : 'none';
                } else {
                    card.style.display = card.dataset.stage === stage ? 'block' : 'none';
                }
            });
        }

        function scrollToSchema(name) {
            const el = document.getElementById('schema-' + name);
            if (el) {
                // Show all schemas first
                filterSchemas('all');

                // Scroll and highlight
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.classList.add('highlight');
                setTimeout(() => el.classList.remove('highlight'), 2000);
            }
        }
    </script>
</body>
</html>
